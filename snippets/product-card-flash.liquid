{% comment %}
  Flash Sale 商品卡片组件
  使用 Shopify 产品对象，仅使用系统折扣（compare_at_price / price）

  参数:
  - product: Shopify 产品对象 (必需)
  - show_reviews: 是否显示评论
  - custom_image: 自定义商品图片 (可选)
  - custom_title: 自定义标题 (可选)
  - custom_description: 自定义描述 (可选)
  - shopify_attributes: Shopify 属性
{% endcomment %}

{% if product %}
  {%- liquid
    # 仅使用系统价格：product.compare_at_price 和 product.price
    assign compare_price = 0
    assign sale_price = product.price
    assign show_compare_price = false
    assign final_discount_percent = 0

    if product.compare_at_price > product.price
      assign compare_price = product.compare_at_price
      assign sale_price = product.price
      assign show_compare_price = true
      assign discount_amount = product.compare_at_price | minus: product.price
      assign final_discount_percent = discount_amount | times: 100.0 | divided_by: product.compare_at_price | round
    endif

    assign show_discount_badge = false
    if final_discount_percent > 0
      assign show_discount_badge = true
    endif
  -%}
  
  <a href="{{ product.url }}" class="product-card product-card--flash" {{ shopify_attributes }}>
    <!-- Product Image -->
    <div class="product-card__image-wrapper">
      {%- liquid
        # 优先使用自定义图片
        assign display_image = custom_image | default: product.featured_image
        assign display_title = custom_title | default: product.title
      -%}
      
      {% if display_image %}
        <img 
          src="{{ display_image | image_url: width: 400 }}"
          srcset="{{ display_image | image_url: width: 200 }} 200w,
                  {{ display_image | image_url: width: 400 }} 400w,
                  {{ display_image | image_url: width: 600 }} 600w"
          sizes="(max-width: 640px) 50vw, (max-width: 1024px) 33vw, 25vw"
          alt="{{ display_title | escape }}"
          width="400"
          height="400"
          loading="lazy"
          class="product-card__image">
      {% else %}
        <div class="product-card__image product-card__image--placeholder">
          {{ 'product-1' | placeholder_svg_tag }}
        </div>
      {% endif %}
      
      <!-- Discount Badge -->
      {% if show_discount_badge %}
        <div class="product-card__discount-badge">
          <span>{{ final_discount_percent }}%</span>
          <span class="product-card__discount-off">OFF</span>
        </div>
      {% endif %}
      
      <!-- Hot Tag -->
      {% if product.tags contains 'HOT' or product.tags contains 'hot' %}
        <div class="product-card__hot-tag">
          <span>HOT</span>
        </div>
      {% endif %}
    </div>
    
    <!-- Product Info -->
    <div class="product-card__info">
      <h3 class="product-card__title">{{ display_title }}</h3>
      
      <!-- Custom Description (Optional) -->
      {% if custom_description != blank %}
        <p class="product-card__description">{{ custom_description }}</p>
      {% endif %}
      
      <!-- Price -->
      <div class="product-card__price">
        {% if show_compare_price and compare_price > sale_price %}
          {% comment %} 显示原价和折扣价（符合 Shopify 官方格式） {% endcomment %}
          <s class="product-card__price-compare">{{ compare_price | money }}</s>
          <span class="product-card__price-sale">{{ sale_price | money }}</span>
        {% else %}
          {% comment %} 只显示当前价格 {% endcomment %}
          <span class="product-card__price-sale">{{ sale_price | money }}</span>
        {% endif %}
      </div>
      
      <!-- Reviews (Optional) -->
      {% if show_reviews and product.metafields.reviews.rating_count.value %}
        <div class="product-card__reviews">
          {{ product.metafields.reviews.rating_count.value }} Review(s)
        </div>
      {% endif %}
    </div>
  </a>
  
  <!-- 商品结构化数据（仅系统折扣） -->
  {% render 'product-structured-data',
    product: product,
    custom_title: custom_title,
    custom_description: custom_description,
    custom_image: custom_image
  %}
{% endif %}

