{% comment %}
  è‡ªå®šä¹‰ HTML å†…å®¹æ¨¡å— - æ”¯æŒ CSS ä½œç”¨åŸŸéš”ç¦»
  
  åŠŸèƒ½ï¼š
  - æ”¯æŒè‡ªå®šä¹‰ HTMLã€CSSã€JavaScript
  - CSS ä½œç”¨åŸŸéš”ç¦»ï¼šç±»ä¼¼ Vue/CSS Modules çš„ä½œç”¨åŸŸéš”ç¦»
  - è‡ªåŠ¨å¤„ç†å†…è”å’Œå¤–éƒ¨æ ·å¼ï¼Œå®Œå…¨éš”ç¦»ï¼Œäº’ä¸å½±å“
  
  Portal ç»„ä»¶æ”¯æŒï¼ˆé€šç”¨è§£å†³æ–¹æ¡ˆï¼‰ï¼š
  - ä½¿ç”¨ MutationObserver ç›‘å¬ body ä¸‹æ–°åˆ›å»ºçš„å…ƒç´ 
  - è‡ªåŠ¨ç»™ Portal å…ƒç´ ï¼ˆä»»ä½•åº“åŠ¨æ€åˆ›å»ºåˆ° body çš„å…ƒç´ ï¼‰æ·»åŠ ä½œç”¨åŸŸå±æ€§
  - æ— éœ€é¢„å®šä¹‰ä»»ä½•é€‰æ‹©å™¨æ¨¡å¼ï¼Œå…¼å®¹æ‰€æœ‰ JS åº“
  
  å…¨å±€æ ·å¼è¯­æ³•ï¼š
  - :global(.selector) { } - å•ä¸ªé€‰æ‹©å™¨ä¿æŒå…¨å±€
  - :global { .a { } .b { } } - æ‰¹é‡å®šä¹‰å…¨å±€æ ·å¼
{% endcomment %}

{%- liquid
  assign section_id = 'custom-html-' | append: section.id
  assign container_type = section.settings.container_type
  assign custom_css = section.settings.custom_css
  assign custom_js = section.settings.custom_js
-%}

{%- style -%}
  #{{ section_id }} {
    padding-top: calc({{ section.settings.padding_top }}px * 0.75);
    padding-bottom: calc({{ section.settings.padding_bottom }}px * 0.75);
    {% if section.settings.background_color != blank %}
      background-color: {{ section.settings.background_color }};
    {% endif %}
    {% if section.settings.background_image != blank %}
      background-image: url('{{ section.settings.background_image | image_url: width: 1920 }}');
      background-repeat: no-repeat;
      background-position: center center;
      background-size: cover;
    {% endif %}
  }

  @media screen and (min-width: 750px) {
    #{{ section_id }} {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  {% if container_type == 'container' %}
    #{{ section_id }} .html-content-wrapper {
      max-width: {{ section.settings.container_width }}px;
      margin: 0 auto;
      padding: 0 {{ section.settings.container_padding }}px;
    }
  {% elsif container_type == 'container-fluid' %}
    #{{ section_id }} .html-content-wrapper {
      padding: 0 {{ section.settings.container_padding }}px;
    }
  {% endif %}

  /* è‡ªå®šä¹‰ CSS - è‡ªåŠ¨éš”ç¦»ä½œç”¨åŸŸ */
  {% if custom_css != blank %}
    #{{ section_id }} {
      {{ custom_css }}
    }
  {% endif %}
{%- endstyle -%}

<div id="{{ section_id }}" class="custom-html-section" {{ section.shopify_attributes }}>
  <div class="html-content-wrapper">
    {% if section.settings.section_title != blank %}
      <div class="section-title" style="text-align: {{ section.settings.title_alignment }}; margin-bottom: {{ section.settings.title_margin }}px;">
        <h2 style="font-size: {{ section.settings.title_size }}px; color: {{ section.settings.title_color }};">
          {{ section.settings.section_title }}
        </h2>
      </div>
    {% endif %}

    {% for block in section.blocks %}
      <div class="html-content-block" {{ block.shopify_attributes }}>
        {% case block.type %}
          {% when 'html' %}
            {{ block.settings.html_content }}
          {% when 'liquid' %}
            {{ block.settings.liquid_content }}
          {% when 'richtext' %}
            <div class="richtext-content">
              {{ block.settings.richtext_content }}
            </div>
          {% when 'code' %}
            <div class="code-block">
              {{ block.settings.code_content }}
            </div>
          {% when 'spacer' %}
            <div style="height: {{ block.settings.spacer_height }}px;"></div>
        {% endcase %}
      </div>
    {% endfor %}
  </div>
</div>

<script>
{%- liquid
  assign use_scoped = section.settings.use_shadow_dom | default: false
-%}
(function() {
  const sectionId = '{{ section_id }}';
  const section = document.getElementById(sectionId);
  if (!section) return;

  const useScopedCSS = {{ use_scoped | json }};
  const scopeAttr = 'data-scope';
  const scopeValue = sectionId;

  /**
   * ============================================
   * é€šç”¨ Portal ç»„ä»¶è§£å†³æ–¹æ¡ˆ
   * ============================================
   * 
   * é—®é¢˜ï¼šJS åº“ä¼šå°† DOM åŠ¨æ€æ’å…¥åˆ° <body>ï¼ˆPortal æ¨¡å¼ï¼‰ï¼Œ
   *       ä½œç”¨åŸŸ CSS æ— æ³•åº”ç”¨åˆ° section å¤–éƒ¨çš„å…ƒç´ 
   * 
   * è§£å†³æ–¹æ¡ˆï¼š
   * 1. ä½¿ç”¨å±æ€§é€‰æ‹©å™¨ [data-scope="xxx"] ä½œä¸ºä½œç”¨åŸŸ
   * 2. MutationObserver ç›‘å¬ body ä¸‹æ–°åˆ›å»ºçš„å…ƒç´ 
   * 3. è‡ªåŠ¨ç»™ Portal å…ƒç´ æ·»åŠ  scope å±æ€§
   * 4. æ”¯æŒ :global è¯­æ³•å¼ºåˆ¶å…¨å±€æ ·å¼
   * 
   * è¿™æ ·æ— è®ºä»€ä¹ˆåº“åˆ›å»ºçš„ Portalï¼Œæ ·å¼éƒ½èƒ½è‡ªåŠ¨ç”Ÿæ•ˆ
   */

  // ç»™ section æ·»åŠ  scope å±æ€§
  section.setAttribute(scopeAttr, scopeValue);

  /**
   * å¤„ç† :global è¯­æ³•
   */
  function processGlobalSyntax(selector) {
    const trimmed = selector.trim();
    // :global(.selector) å½¢å¼
    const parenMatch = trimmed.match(/^:global\((.+)\)$/);
    if (parenMatch) return { global: true, selector: parenMatch[1] };
    // :global .selector å½¢å¼
    const spaceMatch = trimmed.match(/^:global\s+(.+)$/);
    if (spaceMatch) return { global: true, selector: spaceMatch[1] };
    // :global å¼€å¤´
    if (/^:global\b/.test(trimmed)) return { global: true, selector: trimmed.replace(/^:global\s*/, '') };
    return { global: false, selector: trimmed };
  }

  /**
   * æ£€æŸ¥é€‰æ‹©å™¨æ˜¯å¦ä¸ºæ ¹çº§å…ƒç´ ï¼ˆä¸åº”æ·»åŠ ä½œç”¨åŸŸï¼‰
   */
  function isRootSelector(selector) {
    return /^(html|body|:root)\b/.test(selector.trim());
  }

  /**
   * CSS ä½œç”¨åŸŸå¤„ç†å‡½æ•°
   * @param {string} css - åŸå§‹ CSS
   * @param {string} scopePrefix - ä½œç”¨åŸŸå‰ç¼€ï¼Œå¦‚ [data-scope="xxx"]
   */
  function addScopeToCSS(css, scopePrefix) {
    let result = '';
    let i = 0;
    
    // é¢„å¤„ç†ï¼šå¤„ç† :global { ... } å—è¯­æ³•
    css = css.replace(/:global\s*\{([^}]*(?:\{[^}]*\}[^}]*)*)\}/g, function(match, content) {
      return content.replace(/([^{}]+)\{([^{}]+)\}/g, function(rule, sel, decl) {
        return sel.split(',').map(function(s) {
          return '/*@global*/' + s.trim();
        }).join(',') + '{' + decl + '}';
      });
    });
    
    function skipWhitespace() {
      while (i < css.length && /\s/.test(css[i])) {
        result += css[i];
        i++;
      }
    }
    
    function readUntil(chars) {
      let str = '';
      while (i < css.length && chars.indexOf(css[i]) === -1) {
        str += css[i];
        i++;
      }
      return str;
    }
    
    function readBlock() {
      let content = '';
      let depth = 1;
      i++;
      while (i < css.length && depth > 0) {
        if (css[i] === '{') depth++;
        else if (css[i] === '}') depth--;
        if (depth > 0) content += css[i];
        i++;
      }
      return content;
    }
    
    function scopeSelectors(selectorStr) {
      return selectorStr.split(',').map(function(sel) {
        const trimmed = sel.trim();
        if (!trimmed) return sel;
        if (trimmed.includes(scopePrefix)) return sel;
        
        const leadingSpace = sel.match(/^\s*/)[0];
        
        // /*@global*/ æ ‡è®°
        if (trimmed.startsWith('/*@global*/')) {
          return leadingSpace + trimmed.replace('/*@global*/', '');
        }
        
        // :global è¯­æ³•
        const globalResult = processGlobalSyntax(trimmed);
        if (globalResult.global) {
          return leadingSpace + globalResult.selector;
        }
        
        // æ ¹çº§å…ƒç´ 
        if (isRootSelector(trimmed)) {
          return sel;
        }
        
        // æ™®é€šé€‰æ‹©å™¨ï¼šæ·»åŠ ä½œç”¨åŸŸ
        return leadingSpace + scopePrefix + ' ' + trimmed;
      }).join(',');
    }
    
    while (i < css.length) {
      skipWhitespace();
      if (i >= css.length) break;
      
      if (css[i] === '@') {
        let atRule = '@';
        i++;
        
        while (i < css.length && css[i] !== '{' && css[i] !== ';') {
          atRule += css[i];
          i++;
        }
        
        if (css[i] === ';') {
          result += atRule + ';';
          i++;
        } else if (css[i] === '{') {
          const innerContent = readBlock();
          
          if (/^@(-webkit-|-moz-|-o-)?keyframes\s/.test(atRule)) {
            result += atRule + '{' + innerContent + '}';
          } else {
            result += atRule + '{' + addScopeToCSS(innerContent, scopePrefix) + '}';
          }
        }
      } else {
        const selector = readUntil('{');
        
        if (css[i] === '{') {
          const declarations = readBlock();
          result += scopeSelectors(selector) + '{' + declarations + '}';
        }
      }
    }
    
    return result;
  }

  /**
   * ============================================
   * Portal å…ƒç´ è‡ªåŠ¨æ ‡è®°ç³»ç»Ÿ
   * ============================================
   * 
   * ç›‘å¬ body ä¸‹æ–°åˆ›å»ºçš„ç›´æ¥å­å…ƒç´ ï¼ˆé€šå¸¸æ˜¯ Portalï¼‰
   * è‡ªåŠ¨ç»™å®ƒä»¬æ·»åŠ  scope å±æ€§ï¼Œä½¿ä½œç”¨åŸŸæ ·å¼èƒ½å¤Ÿç”Ÿæ•ˆ
   */
  function setupPortalObserver() {
    // è®°å½•ç°æœ‰çš„ body ç›´æ¥å­å…ƒç´ 
    const existingChildren = new Set(Array.from(document.body.children));
    
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        mutation.addedNodes.forEach(function(node) {
          // åªå¤„ç†å…ƒç´ èŠ‚ç‚¹ä¸”æ˜¯ body çš„ç›´æ¥å­å…ƒç´ 
          if (node.nodeType === 1 && node.parentNode === document.body && !existingChildren.has(node)) {
            // ç»™æ–°çš„ Portal å…ƒç´ æ·»åŠ  scope å±æ€§
            node.setAttribute(scopeAttr, scopeValue);
            // åŒæ—¶ç»™æ‰€æœ‰å­å…ƒç´ ä¹Ÿæ·»åŠ ï¼ˆç¡®ä¿æ·±å±‚åµŒå¥—ä¹Ÿèƒ½åŒ¹é…ï¼‰
            node.querySelectorAll('*').forEach(function(child) {
              if (!child.hasAttribute(scopeAttr)) {
                child.setAttribute(scopeAttr, scopeValue);
              }
            });
          }
        });
      });
    });
    
    observer.observe(document.body, { childList: true });
    
    // å½“ section è¢«ç§»é™¤æ—¶ï¼Œæ¸…ç† observer
    const cleanupObserver = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        mutation.removedNodes.forEach(function(node) {
          if (node === section || (node.contains && node.contains(section))) {
            observer.disconnect();
            cleanupObserver.disconnect();
          }
        });
      });
    });
    cleanupObserver.observe(document.body, { childList: true, subtree: true });
  }
  
  // ä½œç”¨åŸŸå‰ç¼€ï¼šä½¿ç”¨å±æ€§é€‰æ‹©å™¨
  const scopePrefix = '[' + scopeAttr + '="' + scopeValue + '"]';

  if (useScopedCSS) {
    // å¯åŠ¨ Portal ç›‘å¬å™¨
    setupPortalObserver();
    
    section.querySelectorAll('.html-content-block').forEach(function(block) {
      if (block.hasAttribute('data-scoped-applied')) return;
      
      try {
        // ç»™ block å†…æ‰€æœ‰å…ƒç´ æ·»åŠ  scope å±æ€§
        block.setAttribute(scopeAttr, scopeValue);
        block.querySelectorAll('*').forEach(function(el) {
          el.setAttribute(scopeAttr, scopeValue);
        });
        
        // å¤„ç†å†…è”æ ·å¼
        block.querySelectorAll('style').forEach(function(styleTag) {
          if (styleTag.textContent.includes('/* auto-scoped */')) return;
          styleTag.textContent = '/* auto-scoped */\n' + addScopeToCSS(styleTag.textContent, scopePrefix);
        });
        
        // å¤„ç†å¤–éƒ¨æ ·å¼
        block.querySelectorAll('link[rel="stylesheet"]').forEach(function(linkTag) {
          const href = linkTag.href;
          fetch(href)
            .then(function(response) { return response.text(); })
            .then(function(css) {
              const newStyle = document.createElement('style');
              newStyle.textContent = '/* auto-scoped */\n' + addScopeToCSS(css, scopePrefix);
              linkTag.parentNode.replaceChild(newStyle, linkTag);
            })
            .catch(function(err) {
              console.warn('æ— æ³•åŠ è½½å¤–éƒ¨æ ·å¼:', href, err);
            });
        });
        
        block.setAttribute('data-scoped-applied', 'true');
        
      } catch (e) {
        console.error('CSS Scoped å¤„ç†å¤±è´¥:', e);
      }
    });
    
    return;
  }

  // æ ‡å‡†æ¨¡å¼ï¼ˆæœªå¯ç”¨ä½œç”¨åŸŸéš”ç¦»ï¼‰ï¼šä¸åšä»»ä½•å¤„ç†
})();
</script>

{% if custom_js != blank %}
  <script>
    (function() {
      {{ custom_js }}
    })();
  </script>
{% endif %}

{% schema %}
{
  "name": "è‡ªå®šä¹‰ HTML å†…å®¹",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "æ ‡é¢˜è®¾ç½®"
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "åˆ†åŒºæ ‡é¢˜ï¼ˆå¯é€‰ï¼‰"
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 16,
      "max": 72,
      "step": 2,
      "unit": "px",
      "label": "æ ‡é¢˜å­—ä½“å¤§å°",
      "default": 32
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "æ ‡é¢˜é¢œè‰²",
      "default": "#000000"
    },
    {
      "type": "select",
      "id": "title_alignment",
      "label": "æ ‡é¢˜å¯¹é½",
      "options": [
        { "value": "left", "label": "å·¦å¯¹é½" },
        { "value": "center", "label": "å±…ä¸­" },
        { "value": "right", "label": "å³å¯¹é½" }
      ],
      "default": "center"
    },
    {
      "type": "range",
      "id": "title_margin",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "æ ‡é¢˜ä¸‹è¾¹è·",
      "default": 40
    },
    {
      "type": "header",
      "content": "å®¹å™¨è®¾ç½®"
    },
    {
      "type": "select",
      "id": "container_type",
      "label": "å®¹å™¨ç±»å‹",
      "options": [
        { "value": "full-width", "label": "å…¨å®½ï¼ˆæ— å®¹å™¨ï¼‰" },
        { "value": "container", "label": "å›ºå®šå®½åº¦å®¹å™¨" },
        { "value": "container-fluid", "label": "æµå¼å®¹å™¨" }
      ],
      "default": "container"
    },
    {
      "type": "range",
      "id": "container_width",
      "min": 800,
      "max": 1920,
      "step": 20,
      "unit": "px",
      "label": "å®¹å™¨æœ€å¤§å®½åº¦",
      "default": 1180,
      "info": "ä»…åœ¨é€‰æ‹©å›ºå®šå®½åº¦å®¹å™¨æ—¶ç”Ÿæ•ˆ"
    },
    {
      "type": "range",
      "id": "container_padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "å®¹å™¨å·¦å³å†…è¾¹è·",
      "default": 15
    },
    {
      "type": "header",
      "content": "èƒŒæ™¯è®¾ç½®"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "èƒŒæ™¯å›¾ç‰‡"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "èƒŒæ™¯é¢œè‰²"
    },
    {
      "type": "header",
      "content": "å†…è¾¹è·"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "ä¸Šå†…è¾¹è·",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "ä¸‹å†…è¾¹è·",
      "default": 0
    },
    {
      "type": "header",
      "content": "æ ·å¼éš”ç¦»è®¾ç½®"
    },
    {
      "type": "checkbox",
      "id": "use_shadow_dom",
      "label": "å¯ç”¨ CSS ä½œç”¨åŸŸéš”ç¦»",
      "default": false,
      "info": "æ ·å¼è‡ªåŠ¨éš”ç¦»ã€‚Portal ç»„ä»¶ï¼ˆModal/Lightbox ç­‰åŠ¨æ€åˆ›å»ºçš„å…ƒç´ ï¼‰è‡ªåŠ¨è·å¾—ä½œç”¨åŸŸå±æ€§"
    },
    {
      "type": "header",
      "content": "è‡ªå®šä¹‰æ ·å¼å’Œè„šæœ¬"
    },
    {
      "type": "html",
      "id": "custom_css",
      "label": "è‡ªå®šä¹‰ CSS",
      "info": "âœ… æ ·å¼è‡ªåŠ¨éš”ç¦» | :global(.class) æˆ– :global { } å¼ºåˆ¶å…¨å±€æ ·å¼"
    },
    {
      "type": "html",
      "id": "custom_js",
      "label": "è‡ªå®šä¹‰ JavaScript"
    }
  ],
  "blocks": [
    {
      "type": "html",
      "name": "HTML ä»£ç å—",
      "settings": [
        {
          "type": "html",
          "id": "html_content",
          "label": "HTML å†…å®¹",
          "info": "ğŸ’¡ æ”¯æŒä»»æ„å¤–éƒ¨åº“ã€‚å¯ç”¨ä½œç”¨åŸŸéš”ç¦»åï¼ŒPortal å…ƒç´ ï¼ˆåŠ¨æ€åˆ›å»ºåˆ° body çš„å…ƒç´ ï¼‰ä¼šè‡ªåŠ¨æ ‡è®°"
        }
      ]
    },
    {
      "type": "liquid",
      "name": "Liquid ä»£ç å—",
      "settings": [
        {
          "type": "html",
          "id": "liquid_content",
          "label": "Liquid å†…å®¹"
        }
      ]
    },
    {
      "type": "richtext",
      "name": "å¯Œæ–‡æœ¬",
      "settings": [
        {
          "type": "richtext",
          "id": "richtext_content",
          "label": "å¯Œæ–‡æœ¬å†…å®¹"
        }
      ]
    },
    {
      "type": "code",
      "name": "åŸå§‹ä»£ç ",
      "settings": [
        {
          "type": "html",
          "id": "code_content",
          "label": "ä»£ç å†…å®¹"
        }
      ]
    },
    {
      "type": "spacer",
      "name": "é—´è·",
      "settings": [
        {
          "type": "range",
          "id": "spacer_height",
          "min": 0,
          "max": 200,
          "step": 4,
          "unit": "px",
          "label": "é—´è·é«˜åº¦",
          "default": 40
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "[gy] Custom HTML Content",
      "blocks": [
        {
          "type": "html"
        }
      ]
    }
  ]
}
{% endschema %}

